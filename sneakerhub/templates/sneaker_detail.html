{% extends "base.html" %}
{% load static %}
{% block title %}{{ sneaker.name }} • SneakerHub{% endblock %}

{% block content %}
<div class="form-error-box hidden">
    <p></p>
</div>
<section class="sneaker-detail-page">
    <div class="sneaker-detail-card">
        <div class="sneaker-detail-image-wrap">
            <img src="{{ sneaker.image.url }}" alt="{{ sneaker.name }}" class="sneaker-detail-image">
        </div>
        <div class="sneaker-detail-info">
            <h1 class="sneaker-detail-title">{{ sneaker.name }}</h1>
            <div class="sneaker-detail-meta">
                <span class="brand">{{ sneaker.brand }}</span>
                <span class="size">Size: {{ sneaker.size|floatformat }}</span>
                <span class="price">£{{ sneaker.price }}</span>
            </div>
            <div class="sneaker-detail-status">
                {% if sneaker.is_sold %}
                    <span class="sold">Sold</span>
                {% else %}
                    <span class="available">Available</span>
                {% endif %}
            </div>
            <div class="sneaker-detail-listed-date">
                <span>Listed on: {{ sneaker.created_at|date:"F j, Y" }}</span>
            </div>
            <div class="sneaker-detail-actions">

                <div class="sneaker-detail-actions-row">
                    <div class="sneaker-detail-actions-grid">
                        {% if not sneaker.is_sold %}
                            <div class="sneaker-detail-action-item">
                                <form method="post" action="{% url 'cart:add' sneaker.id %}" class="sneaker-detail-action">
                                    {% csrf_token %}
                                    <input type="hidden" name="next" value="{% url 'sneaker_detail' sneaker.id %}">
                                    <button class="btn-secondary cart-btn">Add to Cart</button>
                                </form>
                            </div>
                            {% if not in_wishlist %}
                                <div class="sneaker-detail-action-item">
                                    <form method="post" action="{% url 'wishlist_add' sneaker.id %}" class="sneaker-detail-action">
                                        {% csrf_token %}
                                        <input type="hidden" name="next" value="{% url 'sneaker_detail' sneaker.id %}">
                                        <button class="btn-secondary wishlist-btn">Add to Wishlist</button>
                                    </form>
                                </div>
                            {% else %}
                                <div class="sneaker-detail-action-item">
                                    <form method="post" action="{% url 'wishlist_remove' sneaker.id %}" class="sneaker-detail-action">
                                        {% csrf_token %}
                                        <input type="hidden" name="next" value="{% url 'sneaker_detail' sneaker.id %}">
                                        <button class="btn-secondary wishlist-btn">Remove from Wishlist</button>
                                    </form>
                                </div>
                            {% endif %}
                        {% elif sneaker.is_sold and in_wishlist %}
                            <div class="sneaker-detail-action-item">
                                <form method="post" action="{% url 'wishlist_remove' sneaker.id %}" class="sneaker-detail-action">
                                    {% csrf_token %}
                                    <input type="hidden" name="next" value="{% url 'sneaker_detail' sneaker.id %}">
                                    <button class="btn-secondary wishlist-btn">Remove from Wishlist</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% if sneaker in user.sneakers.all %}
                <div class="sneaker-detail-actions-row">
                    <div class="sneaker-detail-actions-grid">
                        <div class="sneaker-detail-action-item">
                            <form method="post" action="{% url 'edit_listing' sneaker.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn-secondary">Edit Listing</button>
                            </form>
                        </div>
                        <div class="sneaker-detail-action-item">
                            <form method="post" action="{% url 'delete_listing' sneaker.id %}" id="delete-form" style="display: inline;">
                                {% csrf_token %}
                                <button type="button" id="delete-open-btn" class="btn-secondary btn-danger">Delete listing</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
                
        </div>
    </div>
</section>

<section class="sneaker-detail-tertiary-container">
    <hr>
    <div class="sneaker-detail-tertiary-grid">
        <div class="sneaker-detail-tertiary-card">
            <div class="sneaker-description">
                <h2>Description</h2>
                <p>{{ sneaker.description }}</p>
            </div>
        </div>
        <div class="sneaker-detail-tertiary-card">
            <div class="sneaker-seller-info">
                <h2>Seller Information</h2>
                <!-- Link to sellers profile, will need to use URL query params to fetch public profile instead of personal -->
                <p>Sold by: <a href="{% url 'publicprofile:public_profile' sneaker.owner.id %}">{{ sneaker.owner.username }}</a></p>
                <p>Member since: {{ sneaker.owner.date_joined|date:"F j, Y" }}</p>
            </div>
        </div>
    </div>
</section>

<!-- Confirmation modal -->
<div id="confirm-modal" class="confirm-modal" aria-hidden="true">
    <div class="confirm-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
        <h3 id="confirm-title">Delete Listing</h3>
        <p class="confirm-message">Are you sure you want to permanently delete this listing? This action cannot be undone.</p>
        <div class="confirm-actions">
            <button id="confirm-delete" class="btn-primary">Yes, Delete</button>
            <button id="cancel-delete" class="btn-primary">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const errorContainer = document.querySelector('.form-error-box');
    const errorBox = document.querySelector('.form-error-box p');


    function showErrorBox(message) {
        if (!errorContainer) return;
        errorBox.textContent = message;
        errorContainer.classList.add('visible');
        errorContainer.classList.remove('hidden');
        if (errorContainer._autoHideTimeout) clearTimeout(errorContainer._autoHideTimeout);
        errorContainer._autoHideTimeout = setTimeout(() => {
            hideErrorBox();
        }, 5000);
    }

    function hideErrorBox() {
        if (!errorContainer) return;
        errorContainer.classList.remove('visible');
        setTimeout(() => {
            errorContainer.classList.add('hidden');
            errorBox.textContent = '';
        }, 400); // match transition
    }

    const errorMessage = urlParams.get('error');
    if (errorMessage === 'already_in_cart') {
        showErrorBox('This item is already in your cart.');
    } else if (errorMessage === 'already_in_wishlist') {
        showErrorBox('This item is already in your wishlist.');
    } else if (errorMessage === 'not_in_wishlist') {
        showErrorBox('This item is not in your wishlist.');
    } else {
        hideErrorBox();
    }
</script>
{% endblock %}
